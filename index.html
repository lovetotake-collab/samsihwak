<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¼ì‹œí™• ë§¤ë§¤ v8 (ë§¤ìˆ˜/ë§¤ë„ ìë™ì „í™˜)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        input[type="text"], input[type="number"], select {
            border: 2px solid #e5e7eb;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
        }
        select {
            cursor: pointer;
            background-color: white;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .input-gray { background: #f3f4f6; border-color: #9ca3af; }
        .input-chart { background: #e0e7ff; border-color: #818cf8; }
        .input-high { background: #fee2e2; border-color: #fca5a5; }
        .input-low { background: #dbeafe; border-color: #93c5fd; }
        .input-bounce { background: #d1fae5; border-color: #6ee7b7; }
        .input-date { background: #fef3c7; border-color: #fbbf24; }
        
        .btn-calculate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-reset {
            background: #6b7280;
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-reset:hover {
            background: #4b5563;
            transform: translateY(-2px);
        }
        
        .btn-google {
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-google:hover {
            background: #357ae8;
        }
        .btn-google:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-backup {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-backup:hover:not(:disabled) {
            background: #059669;
        }
        .btn-backup:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .btn-load {
            background: #f59e0b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-load:hover:not(:disabled) {
            background: #d97706;
        }
        .btn-load:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }
        .sync-status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        .sync-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        .sync-status.syncing {
            background: #fef3c7;
            color: #92400e;
        }
        
        .buy-box {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid;
            transition: all 0.2s;
        }
        .buy-box:hover {
            transform: translateX(4px);
        }
        
        /* ì‹¤ì‹œê°„ ì‹œì„¸ ìŠ¤íƒ€ì¼ */
        .price-up { color: #dc2626; font-weight: bold; }
        .price-down { color: #2563eb; font-weight: bold; }
        .price-flat { color: #1f2937; font-weight: bold; }
        
        /* ë§¤ìˆ˜íƒ€ì  ë„ë‹¬ í‘œì‹œ (ì·¨ì†Œì„  ìŠ¤íƒ€ì¼) */
        .price-reached {
            color: #dc2626;
            text-decoration: line-through;
            font-weight: bold;
        }
        
        /* ê·¼ì ‘ (í˜„ì¬ê°€ > ë§¤ìˆ˜íƒ€ì ): ë…¹ìƒ‰ ë°•ìŠ¤ */
        .proximity-box {
            background: #bbf7d0 !important;
            border: 2px solid #22c55e !important;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            animation: pulse-green 1.5s infinite;
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }
        
        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* ë„ë‹¬ (í˜„ì¬ê°€ â‰ˆ ë§¤ìˆ˜íƒ€ì ): ì£¼í™©ìƒ‰ ë°•ìŠ¤ */
        .proximity-box-equal {
            background: #fed7aa !important;
            border: 2px solid #f97316 !important;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.5);
            animation: pulse-orange 1.5s infinite;
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }
        
        @keyframes pulse-orange {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* ë„ë‹¬ ì´í•˜ (í˜„ì¬ê°€ < ë§¤ìˆ˜íƒ€ì ): ì£¼í™©ìƒ‰ ì‹¤ì„  ë°•ìŠ¤ */
        .proximity-box-below {
            background: white !important;
            border: 2px solid #f97316 !important;
            color: #f97316 !important;
            font-weight: bold;
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }
        
        /* ë§¤ë„íƒ€ì  ê·¼ì ‘ (í˜„ì¬ê°€ < ë§¤ë„íƒ€ì , 1% ì´ë‚´): íŒŒë€ìƒ‰ ë°•ìŠ¤ */
        .sell-proximity-box {
            background: #bfdbfe !important;
            border: 2px solid #3b82f6 !important;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            animation: pulse-blue 1.5s infinite;
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }
        
        @keyframes pulse-blue {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* ë§¤ë„íƒ€ì  ë„ë‹¬ (í˜„ì¬ê°€ >= ë§¤ë„íƒ€ì ): íŒŒë€ìƒ‰ ì‹¤ì„  ë°•ìŠ¤ */
        .sell-proximity-box-reached {
            background: white !important;
            border: 2px solid #3b82f6 !important;
            color: #3b82f6 !important;
            font-weight: bold;
            border-radius: 6px;
            padding: 4px 8px;
            display: inline-block;
        }
        
        .reached-check {
            color: #10b981;
            font-size: 18px;
            font-weight: bold;
            margin-left: 4px;
        }
        
        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }
        .api-status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        .api-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .realtime-price {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            background: #f3f4f6;
            margin-left: 8px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.3;
        }
        
        .realtime-price-value {
            font-weight: bold;
            font-size: 13px;
        }
        
        .realtime-price-change {
            font-size: 11px;
            margin-top: 2px;
        }
        
        .buy-40 { background: #fce7f3; border-color: #f472b6; }
        .buy-50 { background: #dbeafe; border-color: #60a5fa; }
        .buy-60 { background: #fef9c3; border-color: #facc15; }
        .buy-70 { background: #fee2e2; border-color: #f87171; }
        
        .delete-btn {
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .drag-handle {
            cursor: move;
            color: #9ca3af;
            padding: 0 8px;
            user-select: none;
        }
        .drag-handle:hover {
            color: #667eea;
        }
        
        /* ì•Œë¦¼ ì„¤ì • ìŠ¤íƒ€ì¼ */
        .alert-settings-btn {
            background: #f59e0b;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        .alert-settings-btn:hover {
            background: #d97706;
        }
        .alert-settings-btn.disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .alert-modal.active {
            display: flex;
        }
        .alert-modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #667eea;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
        .alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .dragging {
            opacity: 0.5;
            background: #f3f4f6;
        }
        
        table {
            border-collapse: collapse;
        }
        table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        table tr:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .d-day-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
        }
        .d-day-badge.orange {
            background: #f97316;
            color: white;
        }
        .d-day-badge.warning {
            background: #fbbf24;
            color: #78350f;
        }
        .d-day-badge.danger {
            background: #ef4444;
            color: white;
        }
        
        .rise-rate-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
        }
        
        .chart-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 4px;
        }
        .chart-badge.minute {
            background: #fbbf24;
            color: #78350f;
        }
        .chart-badge.daily {
            background: #60a5fa;
            color: #1e3a8a;
        }
        
        .stock-list-section {
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .minute-section {
            background: #fef3c7;
            border: 2px solid #fbbf24;
        }
        .daily-section {
            background: #dbeafe;
            border: 2px solid #60a5fa;
        }
        
        @media (max-width: 768px) {
            .grid.grid-cols-3 {
                grid-template-columns: 1fr;
            }
            .grid.grid-cols-6 {
                grid-template-columns: repeat(2, 1fr);
            }
            table {
                font-size: 10px;
            }
            table th, table td {
                padding: 6px 2px !important;
            }
            .buy-box {
                padding: 12px;
            }
            .d-day-badge {
                font-size: 9px;
                padding: 1px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto">
        <!-- í—¤ë” -->
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                        ğŸ“Š ì‚¼ì‹œí™•ë§¤ë§¤ í™•ì¥íŒ v1
                    </h1>
                    <p class="text-gray-600 mt-2">ì²« ë°˜ë“±ì„ ë…¸ë¦¬ëŠ” ë¶„í• ë§¤ìˆ˜ ì „ëµ (ì‹¤ì‹œê°„ ì‹œì„¸ ì—°ë™)</p>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <!-- í‚¤ì›€ API ìƒíƒœ -->
                    <div class="flex items-center gap-2">
                        <button id="alertSettingsBtn" class="alert-settings-btn" onclick="openAlertSettings()">
                            <span>ğŸ””</span>
                            <span>ì•Œë¦¼ ì„¤ì •</span>
                        </button>
                        <div id="apiStatus" class="api-status disconnected">
                            <span>â—</span>
                            <span id="apiStatusText">í‚¤ì›€ API ì—°ê²° ì•ˆë¨</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="backupBtn" class="btn-backup" onclick="manualBackup()" disabled>
                            <span>ğŸ’¾</span>
                            <span>ë°±ì—…</span>
                        </button>
                        <button id="loadBtn" class="btn-load" onclick="manualLoad()" disabled>
                            <span>ğŸ“¥</span>
                            <span>ë¡œë“œ</span>
                        </button>
                        <button id="googleSignInBtn" class="btn-google" onclick="handleAuthClick()">
                            <svg width="18" height="18" viewBox="0 0 18 18">
                                <path fill="#fff" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                                <path fill="#fff" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                                <path fill="#fff" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                                <path fill="#fff" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                            </svg>
                            <span id="googleBtnText">êµ¬ê¸€ ë¡œê·¸ì¸</span>
                        </button>
                    </div>
                    <div id="syncStatus" class="sync-status disconnected">
                        <span>â—</span>
                        <span id="statusText">ì—°ê²° ì•ˆë¨</span>
                    </div>
                    <div id="lastSyncTime" class="text-xs text-gray-500"></div>
                </div>
            </div>
        </div>


        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ“ ì¢…ëª© ì •ë³´ ì…ë ¥</h2>
            
            <!-- í‚¤ì›€ API ì„œë²„ ì£¼ì†Œ (ìˆ¨ê¹€) -->
            <input type="hidden" id="apiServerUrl" value="http://localhost:5000">
            
            
            <div class="grid grid-cols-6 gap-3">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-indigo-600">ì°¨íŠ¸</label>
                    <select id="chartType" class="input-chart">
                        <option value="minute">ë¶„ë´‰</option>
                        <option value="daily">ì¼ë´‰</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-600">ì¢…ëª©ëª…</label>
                    <input type="text" id="stockName" placeholder="" class="input-gray">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-purple-600">ì¢…ëª©ì½”ë“œ</label>
                    <input type="text" id="stockCode" placeholder="" maxlength="6" class="input-gray">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-amber-600">ê³ ì ì¼</label>
                    <input type="text" id="highDate" placeholder="" class="input-date" maxlength="6" oninput="formatDateInput(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-red-600">ê³ ì  (ì›)</label>
                    <input type="text" id="highPrice" placeholder="" class="input-high" oninput="formatInput(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-blue-600">ì €ì  (ì›)</label>
                    <input type="text" id="lowPrice" placeholder="" class="input-low" oninput="formatInput(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-green-600">ë°˜ë“±ì €ì  (ì›)</label>
                    <input type="text" id="bouncePrice" placeholder="ì„ íƒì‚¬í•­" class="input-bounce" oninput="formatInput(this)">
                </div>
            </div>
            <div class="mt-4 grid grid-cols-3 gap-3">
                <button class="btn-calculate" onclick="calculate()">
                    âœ… ê³„ì‚°í•˜ê¸°
                </button>
                <button class="btn-calculate" onclick="addToList()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    ğŸ’¾ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                </button>
                <button class="btn-reset" onclick="resetInputs()">
                    ğŸ”„ ì…ë ¥ ì´ˆê¸°í™”
                </button>
            </div>
            <div class="mt-3 text-sm text-gray-600 bg-purple-50 p-3 rounded-lg border border-purple-200">
                ğŸ’¡ <strong>íŒ:</strong> ê³ ì , ì €ì ë§Œ ì…ë ¥í•´ë„ ë§¤ìˆ˜ íƒ€ì ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë“±ì´ ë‚˜ì˜¤ë©´ ë°˜ë“±ì €ì ì„ ì…ë ¥í•˜ì—¬ ë§¤ë„ íƒ€ì ì„ í™•ì¸í•˜ì„¸ìš”.
            </div>
        </div>

        <!-- ì¢…ëª©ë¦¬ìŠ¤íŠ¸ -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ“‹ ì¢…ëª©ë¦¬ìŠ¤íŠ¸</h2>
            <p class="text-sm text-gray-500 mb-3">ì¢…ëª©ì„ í´ë¦­í•˜ì—¬ ìƒì„¸ íƒ€ì ì„ í™•ì¸í•˜ì„¸ìš”</p>
            
            <!-- ë¶„ë´‰ ì¢…ëª©ë¦¬ìŠ¤íŠ¸ -->
            <div class="stock-list-section minute-section">
                <h3 class="text-lg font-bold mb-3 text-amber-900 flex items-center gap-2">
                    âš¡ ë¶„ë´‰ ì¢…ëª©ë¦¬ìŠ¤íŠ¸
                    <span class="text-sm font-normal text-amber-700">(ë‹¨ê¸° ë§¤ë§¤)</span>
                </h3>
                <div id="minuteStockList"></div>
            </div>
            
            <!-- ì¼ë´‰ ì¢…ëª©ë¦¬ìŠ¤íŠ¸ -->
            <div class="stock-list-section daily-section">
                <h3 class="text-lg font-bold mb-3 text-blue-900 flex items-center gap-2">
                    ğŸ“ˆ ì¼ë´‰ ì¢…ëª©ë¦¬ìŠ¤íŠ¸
                    <span class="text-sm font-normal text-blue-700">(ì¤‘ì¥ê¸° ë§¤ë§¤)</span>
                </h3>
                <div id="dailyStockList"></div>
            </div>
        </div>

        <!-- ë§¤ìˆ˜/ë§¤ë„ íƒ€ì  -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <!-- ë§¤ìˆ˜ íƒ€ì  -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ¯ ë§¤ìˆ˜ íƒ€ì </h2>
                <p class="text-sm text-gray-500 mb-3">í”¼ë³´ë‚˜ì¹˜ ê¸°ì¤€ ë¶„í• ë§¤ìˆ˜ ì§€ì </p>
                <div id="buyPoints"></div>
            </div>

            <!-- ë§¤ë„ íƒ€ì  -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-4 text-gray-700" id="sellTitle">ğŸ’° ë§¤ë„ íƒ€ì </h2>
                <p class="text-sm text-gray-500 mb-3">ë°˜ë“±ì €ì  ê¸°ì¤€ ë§¤ë„ ì§€ì </p>
                <div id="sellPoints">
                    <div class="text-center text-gray-500 py-8">
                        ë°˜ë“±ì €ì ì„ ì…ë ¥í•˜ë©´<br>ë§¤ë„ íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤
                    </div>
                </div>
            </div>
        </div>

        <!-- ë§¤ë§¤ ì „ëµ -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ’¡ ë§¤ë§¤ ì „ëµ</h2>
            <div class="text-sm text-gray-700 space-y-2 bg-amber-50 p-4 rounded-lg border-2 border-amber-200">
                <p><strong>â€¢ ë§¤ìˆ˜:</strong> ê³ ì ì—ì„œ 40%, 50%, 60%, 70% í•˜ë½ ì‹œì ì—ì„œ ë¶„í•  ë§¤ìˆ˜ ëŒ€ê¸°</p>
                <p><strong>â€¢ ë§¤ë„:</strong> ë°˜ë“±ì €ì ì—ì„œ 25%, 33%, 50%, 66% ìƒìŠ¹ ì§€ì ì—ì„œ ë¶„í•  ë§¤ë„</p>
                <p><strong>â€¢ ìƒí™©ë³„ ë§¤ë„ ì „ëµ:</strong></p>
                <p class="ml-4">- 40%ì—ì„œ ë§¤ìˆ˜: ìµœëŒ€ â†’ 50% ì´ìƒ ë°˜ë“±ì—ì„œ ë§¤ë„</p>
                <p class="ml-4">- 50%ì—ì„œ ë§¤ìˆ˜: ìµœëŒ€ â†’ 50% ì´ìƒ ë°˜ë“±ì—ì„œ ë§¤ë„</p>
                <p class="ml-4">- 60%ì—ì„œ ë§¤ìˆ˜: ìµœëŒ€ â†’ 33% ì´ìƒ ë°˜ë“±ì—ì„œ ë§¤ë„</p>
                <p class="ml-4">- 70%ì—ì„œ ë§¤ìˆ˜: ìµœëŒ€ â†’ 25% ì´ìƒ ë°˜ë“±ì—ì„œ ë§¤ë„</p>
                <div class="mt-4 pt-3 border-t-2 border-amber-300">
                    <p class="text-red-600 font-bold">âš ï¸ í•œ ë²ˆ ì²­ì‚°ë˜ë©´ í•´ë‹¹ ì¢…ëª©ì˜ ë§¤ë§¤ëŠ” ì¢…ë£Œí•©ë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œ API ì„¤ì • ==========
        const CLIENT_ID = '574140412573-n0jau2i3uph1v5p3hi9v004m44bnopq8.apps.googleusercontent.com';
        const API_KEY = '';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILE_NAME = 'samsihwak_extended_stocks.json';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let isSignedIn = false;
        let driveFileId = null;
        let tokenRefreshTimer = null;

        // ========== ë°ì´í„° ê´€ë¦¬ ==========
        let stockDatabase = [];
        let currentSelectedIndex = -1;
        let draggedIndex = null;

        // localStorageì—ì„œ ë°ì´í„° ë¡œë“œ
        const savedData = localStorage.getItem('samsihwakExtendedStocks');
        if (savedData) {
            stockDatabase = JSON.parse(savedData);
        }

        // ========== Socket.IO ì‹¤ì‹œê°„ ì—°ê²° ==========
        let apiServerUrl = 'http://localhost:5000';
        let isKiwoomConnected = false;
        let socket = null;
        
        // Socket.IO ì—°ê²° ì´ˆê¸°í™”
        function initSocketConnection() {
            if (socket && socket.connected) {
                socket.disconnect();
            }
            
            socket = io(apiServerUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 10
            });
            
            // ì—°ê²° ì„±ê³µ
            socket.on('connect', () => {
                console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
                isKiwoomConnected = true;
                updateAPIStatus('connected', 'í‚¤ì›€ API ì—°ê²°ë¨');
                registerAllStocks();
            });
            
            // ì—°ê²° ëŠê¹€
            socket.on('disconnect', () => {
                console.log('âŒ WebSocket ì—°ê²° ëŠê¹€');
                isKiwoomConnected = false;
                updateAPIStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
            });
            
            // ì—°ê²° ìƒíƒœ ìˆ˜ì‹ 
            socket.on('connection_status', (data) => {
                if (data.logged_in) {
                    isKiwoomConnected = true;
                    updateAPIStatus('connected', 'í‚¤ì›€ API ì—°ê²°ë¨');
                } else {
                    isKiwoomConnected = false;
                    updateAPIStatus('disconnected', 'í‚¤ì›€ API ë¡œê·¸ì¸ í•„ìš”');
                }
            });
            
            // ë“±ë¡ ì„±ê³µ
            socket.on('registration_success', (data) => {
                console.log(`ğŸŸ¢ ${data.message}`);
            });
            
            // ì—ëŸ¬ ìˆ˜ì‹ 
            socket.on('error', (data) => {
                console.error('âŒ ì˜¤ë¥˜:', data.message);
            });
            
            // ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ 
            socket.on('realtime_update', (data) => {
                const { code, name, data: priceData } = data;
                
                const stock = stockDatabase.find(s => s.code === code);
                if (stock) {
                    stock.currentPrice = priceData.current_price;
                    stock.changeRate = priceData.change_rate;
                    stock.prevDiff = priceData.prev_diff;
                    
                    localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                    renderStockList();
                }
            });
            
            // ë§¤ìˆ˜/ë§¤ë„íƒ€ì  ì•Œë¦¼ ìˆ˜ì‹ 
            socket.on('price_alert', (data) => {
                const { name, current_price, target_point, point_label, diff_percent, type, status, watch_mode } = data;
                
                const modeText = watch_mode === 'sell' ? 'ë§¤ë„' : 'ë§¤ìˆ˜';
                console.log(`ğŸ”” ${modeText}íƒ€ì  ì•Œë¦¼ ìˆ˜ì‹ :`, data);
                
                // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
                const targetLabel = watch_mode === 'sell' ? `ë§¤ë„(${point_label})` : `ë§¤ìˆ˜(${point_label})`;
                const message = `
                    <strong>${name}</strong><br>
                    í˜„ì¬ê°€: â‚©${current_price.toLocaleString()}<br>
                    ${targetLabel}: â‚©${(target_point || 0).toLocaleString()}<br>
                    ì°¨ì´: ${diff_percent > 0 ? '+' : ''}${diff_percent.toFixed(2)}%
                `;
                
                showAlertToast(message, type, watch_mode || 'buy');
            });
        }
        
        // ëª¨ë“  ì¢…ëª©ì„ ì„œë²„ì— ë“±ë¡ (ë°˜ë“±ì €ì  ìœ ë¬´ì— ë”°ë¼ ë§¤ìˆ˜/ë§¤ë„íƒ€ì  ìë™ ì „í™˜)
        function registerAllStocks() {
            if (!socket || !socket.connected) return;
            
            const chartType = document.getElementById('chartType').value;
            
            const stocksToRegister = stockDatabase
                .filter(s => s.code && s.chartType === chartType)
                .map(s => {
                    let targetPoints = [];
                    let watchMode = 'buy';
                    let pointLabels = [];
                    
                    if (s.high && s.low) {
                        const range = s.high - s.low;
                        
                        // ë°˜ë“±ì €ì ì´ ìˆìœ¼ë©´ ë§¤ë„íƒ€ì  ê°ì‹œ, ì—†ìœ¼ë©´ ë§¤ìˆ˜íƒ€ì  ê°ì‹œ
                        if (s.bounce !== null && s.bounce !== undefined) {
                            // ë§¤ë„íƒ€ì  ê°ì‹œ ëª¨ë“œ - 25%, 33%, 50%, 75% ë°˜ë“±
                            const bounceRange = s.high - s.bounce;
                            watchMode = 'sell';
                            
                            targetPoints = [
                                adjustSellPrice(s.bounce + (bounceRange * 0.25)).adjusted,
                                adjustSellPrice(s.bounce + (bounceRange * 0.33)).adjusted,
                                adjustSellPrice(s.bounce + (bounceRange * 0.50)).adjusted,
                                adjustSellPrice(s.bounce + (bounceRange * 0.75)).adjusted
                            ];
                            pointLabels = ['25%ë°˜ë“±', '33%ë°˜ë“±', '50%ë°˜ë“±', '75%ë°˜ë“±'];
                            
                        } else {
                            // ë§¤ìˆ˜íƒ€ì  ê°ì‹œ ëª¨ë“œ
                            watchMode = 'buy';
                            
                            if (chartType === 'daily') {
                                // ì¼ë´‰: 38.2%, 45%, 50%, 55%, 60%, 65%, 70%
                                targetPoints = [
                                    adjustBuyPrice(s.high - (range * 0.382)).adjusted,
                                    adjustBuyPrice(s.high - (range * 0.45)).adjusted,
                                    adjustBuyPrice(s.high - (range * 0.50)).adjusted,
                                    adjustBuyPrice(s.high - (range * 0.55)).adjusted,
                                    adjustBuyPrice(s.high - (range * 0.60)).adjusted,
                                    adjustBuyPrice(s.high - (range * 0.65)).adjusted,
                                    adjustBuyPrice(s.high - (range * 0.70)).adjusted
                                ];
                                pointLabels = ['40%', '45%', '50%', '55%', '60%', '65%', '70%'];
                            } else {
                                // ë¶„ë´‰: 38.2%, 50%, 60%, 70%
                                targetPoints = [
                                    adjustBuyPrice(s.high - (range * 0.382)).adjusted,
                                    adjustBuyPrice(s.high - (range * 0.50)).adjusted,
                                    adjustBuyPrice(s.high - (range * 0.60)).adjusted,
                                    adjustBuyPrice(s.high - (range * 0.70)).adjusted
                                ];
                                pointLabels = ['40%', '50%', '60%', '70%'];
                            }
                        }
                    }
                    
                    return {
                        code: s.code,
                        name: s.name,
                        watch_mode: watchMode,
                        target_points: targetPoints,
                        point_labels: pointLabels,
                        high: s.high,
                        low: s.low,
                        bounce: s.bounce
                    };
                });
            
            if (stocksToRegister.length > 0) {
                const sourceType = chartType === 'minute' ? 'samsihwak_ë¶„ë´‰' : 'samsihwak_ì¼ë´‰';
                
                socket.emit('register_stocks', { 
                    source: sourceType,
                    stocks: stocksToRegister 
                });
                
                // ë§¤ìˆ˜/ë§¤ë„ ê°ì‹œ ì¢…ëª© ìˆ˜ ì¹´ìš´íŠ¸
                const buyCount = stocksToRegister.filter(s => s.watch_mode === 'buy').length;
                const sellCount = stocksToRegister.filter(s => s.watch_mode === 'sell').length;
                console.log(`ğŸ“¡ [${sourceType}] ì‹¤ì‹œê°„ ì‹œì„¸ ë“±ë¡: ë§¤ìˆ˜ê°ì‹œ ${buyCount}ê°œ, ë§¤ë„ê°ì‹œ ${sellCount}ê°œ`);
            }
        }

        // í‚¤ì›€ API ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function connectKiwoomAPI() {
            const urlInput = document.getElementById('apiServerUrl');
            apiServerUrl = urlInput.value.trim();
            
            if (!apiServerUrl) {
                alert('API ì„œë²„ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                const response = await fetch(`${apiServerUrl}/api/login_status`);
                const data = await response.json();
                
                if (data.logged_in) {
                    alert('âœ… í‚¤ì›€ API ì—°ê²° ì„±ê³µ! WebSocket ì‹¤ì‹œê°„ ì—°ê²°ì„ ì‹œì‘í•©ë‹ˆë‹¤.');
                    initSocketConnection();
                } else {
                    alert('âŒ í‚¤ì›€ APIì— ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\në¨¼ì € í‚¤ì›€ ì„œë²„(python app.py)ë¥¼ ì‹¤í–‰í•˜ê³  ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                    updateAPIStatus('disconnected', 'í‚¤ì›€ API ë¡œê·¸ì¸ í•„ìš”');
                }
            } catch (error) {
                console.error('API ì—°ê²° ì˜¤ë¥˜:', error);
                updateAPIStatus('disconnected', 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                alert('âŒ API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì„œë²„ ì£¼ì†Œë¥¼ í™•ì¸í•˜ê±°ë‚˜ í‚¤ì›€ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
            }
        }

        // API ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateAPIStatus(status, text) {
            const statusEl = document.getElementById('apiStatus');
            const textEl = document.getElementById('apiStatusText');
            
            statusEl.className = `api-status ${status}`;
            textEl.textContent = text;
        }

        // ë§¤ìˆ˜íƒ€ì  ê·¼ì ‘ë„ ì²´í¬ (3ë‹¨ê³„: close, equal, below)
        // chartType: 'minute' = ë¶„ë´‰, 'daily' = ì¼ë´‰
        function checkProximity(currentPrice, targetPrice, chartType = 'minute') {
            if (!currentPrice || !targetPrice) return { isClose: false, isEqual: false, isBelow: false };
            
            const diff = currentPrice - targetPrice;
            const percentage = (diff / targetPrice) * 100;
            
            // ë¶„ë´‰: ë…¹ìƒ‰ 0.3~1.0%, ì£¼í™© 0~0.3%
            // ì¼ë´‰: ë…¹ìƒ‰ 1~3%, ì£¼í™© 0~1%
            let closeMax, equalMax;
            if (chartType === 'daily') {
                closeMax = 3.0;  // ë…¹ìƒ‰: 1~3%
                equalMax = 1.0;  // ì£¼í™©: 0~1%
            } else {
                closeMax = 1.0;  // ë…¹ìƒ‰: 0.3~1.0%
                equalMax = 0.3;  // ì£¼í™©: 0~0.3%
            }
            
            // ë„ë‹¬ ì´í•˜ (í˜„ì¬ê°€ < íƒ€ì ê°€)
            if (diff < 0) {
                return { isClose: false, isEqual: false, isBelow: true };
            }
            
            // ë„ë‹¬ (í˜„ì¬ê°€ â‰ˆ íƒ€ì ê°€)
            if (percentage >= 0 && percentage <= equalMax) {
                return { isClose: false, isEqual: true, isBelow: false };
            }
            
            // ê·¼ì ‘
            if (percentage > equalMax && percentage <= closeMax) {
                return { isClose: true, isEqual: false, isBelow: false };
            }
            
            return { isClose: false, isEqual: false, isBelow: false };
        }
        
        // ë§¤ë„íƒ€ì  ê·¼ì ‘ë„ ì²´í¬ (í˜„ì¬ê°€ >= ë§¤ë„íƒ€ì ì´ë©´ ë„ë‹¬)
        function checkSellProximity(currentPrice, targetPrice, chartType = 'minute') {
            if (!currentPrice || !targetPrice) return { isClose: false, isReached: false };
            
            const diff = currentPrice - targetPrice;
            const percentage = (diff / targetPrice) * 100;
            
            // ë¶„ë´‰: 1% ì´ë‚´ ê·¼ì ‘
            // ì¼ë´‰: 3% ì´ë‚´ ê·¼ì ‘
            const closeMax = chartType === 'daily' ? 3.0 : 1.0;
            
            // ë„ë‹¬ (í˜„ì¬ê°€ >= ë§¤ë„íƒ€ì )
            if (diff >= 0) {
                return { isClose: false, isReached: true };
            }
            
            // ê·¼ì ‘ (-1% ì´ë‚´, ì¦‰ í˜„ì¬ê°€ê°€ ë§¤ë„íƒ€ì ë³´ë‹¤ 1% ë¯¸ë§Œìœ¼ë¡œ ë‚®ìŒ)
            if (percentage >= -closeMax && percentage < 0) {
                return { isClose: true, isReached: false };
            }
            
            return { isClose: false, isReached: false };
        }


        // ========== Google API ì´ˆê¸°í™” ==========
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('googleSignInBtn').disabled = false;
            }
        }

        // ========== êµ¬ê¸€ ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ==========
        function handleAuthClick() {
            if (isSignedIn) {
                handleSignoutClick();
            } else {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    
                    localStorage.setItem('google_access_token_samsihwak', resp.access_token);
                    if (resp.expires_in) {
                        const expiryTime = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem('google_token_expiry_samsihwak', expiryTime.toString());
                        setupTokenRefresh(resp.expires_in);
                    }
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    await loadFromGoogleDrive();
                };

                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
                tokenRefreshTimer = null;
            }
            
            localStorage.removeItem('google_access_token_samsihwak');
            localStorage.removeItem('google_token_expiry_samsihwak');
            
            isSignedIn = false;
            updateSyncStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
            document.getElementById('googleBtnText').textContent = 'êµ¬ê¸€ ë¡œê·¸ì¸';
            document.getElementById('lastSyncTime').textContent = '';
            document.getElementById('backupBtn').disabled = true;
            document.getElementById('loadBtn').disabled = true;
        }

        // ========== ì €ì¥ëœ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸ ë³µì› ==========
        async function restoreLoginState() {
            const savedToken = localStorage.getItem('google_access_token_samsihwak');
            const tokenExpiry = localStorage.getItem('google_token_expiry_samsihwak');
            
            if (savedToken && tokenExpiry) {
                if (Date.now() < parseInt(tokenExpiry)) {
                    gapi.client.setToken({
                        access_token: savedToken
                    });
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    
                    const remainingSeconds = Math.floor((parseInt(tokenExpiry) - Date.now()) / 1000);
                    setupTokenRefresh(remainingSeconds);
                    
                    await loadFromGoogleDrive();
                } else {
                    localStorage.removeItem('google_access_token_samsihwak');
                    localStorage.removeItem('google_token_expiry_samsihwak');
                }
            }
        }

        // ========== í† í° ìë™ ê°±ì‹  ì„¤ì • ==========
        function setupTokenRefresh(expiresInSeconds) {
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }
            
            const refreshTime = Math.max((expiresInSeconds - 300) * 1000, 60 * 1000);
            
            tokenRefreshTimer = setTimeout(async () => {
                if (isSignedIn && tokenClient) {
                    try {
                        tokenClient.callback = async (resp) => {
                            if (resp.error === undefined) {
                                localStorage.setItem('google_access_token_samsihwak', resp.access_token);
                                if (resp.expires_in) {
                                    const expiryTime = Date.now() + (resp.expires_in * 1000);
                                    localStorage.setItem('google_token_expiry_samsihwak', expiryTime.toString());
                                    setupTokenRefresh(resp.expires_in);
                                }
                                
                                gapi.client.setToken({
                                    access_token: resp.access_token
                                });
                                
                                console.log('í† í°ì´ ìë™ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        };
                        
                        tokenClient.requestAccessToken({prompt: ''});
                    } catch (err) {
                        console.error('í† í° ìë™ ê°±ì‹  ì‹¤íŒ¨:', err);
                    }
                }
            }, refreshTime);
        }

        // ========== ë™ê¸°í™” ìƒíƒœ í‘œì‹œ ==========
        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('statusText');
            statusEl.className = `sync-status ${status}`;
            textEl.textContent = text;
        }

        function updateLastSyncTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('ko-KR');
            document.getElementById('lastSyncTime').textContent = `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${timeStr}`;
        }

        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼ ì°¾ê¸° ==========
        async function findDriveFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    return files[0].id;
                }
                return null;
            } catch (err) {
                console.error('íŒŒì¼ ê²€ìƒ‰ ì˜¤ë¥˜:', err);
                return null;
            }
        }

        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ==========
        async function loadFromGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            try {
                driveFileId = await findDriveFile();
                
                if (driveFileId) {
                    const response = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media',
                    });
                    
                    stockDatabase = JSON.parse(response.body);
                    localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                    renderStockList();
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    updateLastSyncTime();
                    
                    // ì‹¤ì‹œê°„ ì‹œì„¸ ì¬ë“±ë¡
                    registerAllStocks();
                } else {
                    updateSyncStatus('connected', 'ì—°ê²°ë¨ (íŒŒì¼ ì—†ìŒ)');
                }
            } catch (err) {
                console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', err);
                updateSyncStatus('connected', 'ì—°ê²°ë¨');
            }
        }

        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì €ì¥ ==========
        async function saveToGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
            
            try {
                const data = JSON.stringify(stockDatabase, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                
                if (driveFileId) {
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                } else {
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                    
                    const result = await response.json();
                    driveFileId = result.id;
                }
                
                updateSyncStatus('connected', 'ì—°ê²°ë¨');
                updateLastSyncTime();
            } catch (err) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', err);
                updateSyncStatus('connected', 'ì—°ê²°ë¨ (ì €ì¥ ì‹¤íŒ¨)');
            }
        }

        // ========== ìˆ˜ë™ ë°±ì—… ==========
        async function manualBackup() {
            if (!isSignedIn) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await saveToGoogleDrive();
                alert('ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        // ========== ìˆ˜ë™ ë¶ˆëŸ¬ì˜¤ê¸° ==========
        async function manualLoad() {
            if (!isSignedIn) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) {
                await loadFromGoogleDrive();
                alert('ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤!');
            }
        }

        // ========== í˜¸ê°€ë‹¨ìœ„ ê³„ì‚° ==========
        function getTickSize(price) {
            if (price < 2000) return 1;
            if (price < 5000) return 5;
            if (price < 20000) return 10;
            if (price < 50000) return 50;
            if (price < 200000) return 100;
            if (price < 500000) return 500;
            return 1000;
        }

        function adjustBuyPrice(price) {
            const tickSize = getTickSize(price);
            const adjusted = Math.ceil(price / tickSize) * tickSize;
            return { original: price, adjusted: adjusted };
        }

        function adjustSellPrice(price) {
            const tickSize = getTickSize(price);
            const adjusted = Math.floor(price / tickSize) * tickSize;
            return { original: price, adjusted: adjusted };
        }

        // ========== í¬ë§·íŒ… í•¨ìˆ˜ ==========
        function formatDateInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length > 6) value = value.substring(0, 6);
            input.value = value;
        }

        function formatInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value) {
                input.value = parseInt(value).toLocaleString('ko-KR');
            }
        }

        function formatPrice(price) {
            return Math.round(price).toLocaleString('ko-KR');
        }

        function formatPriceWithOriginal(adjusted, original) {
            const formattedAdjusted = formatPrice(adjusted);
            if (Math.abs(adjusted - original) > 0.01) {
                return `${formattedAdjusted}ì› <span class="text-xs text-gray-500">(${formatPrice(original)}ì›)</span>`;
            }
            return `${formattedAdjusted}ì›`;
        }

        function getNumericValue(elementId) {
            const value = document.getElementById(elementId).value.replace(/,/g, '');
            return value ? parseFloat(value) : null;
        }

        // ========== í•œêµ­ ê³µíœ´ì¼ ë°ì´í„° ==========
        function getKoreanHolidays(year) {
            const holidays = [];
            
            // ê³ ì • ê³µíœ´ì¼
            holidays.push(new Date(year, 0, 1));   // ì‹ ì •
            holidays.push(new Date(year, 2, 1));   // ì‚¼ì¼ì ˆ
            holidays.push(new Date(year, 4, 5));   // ì–´ë¦°ì´ë‚ 
            holidays.push(new Date(year, 5, 6));   // í˜„ì¶©ì¼
            holidays.push(new Date(year, 7, 15));  // ê´‘ë³µì ˆ
            holidays.push(new Date(year, 9, 3));   // ê°œì²œì ˆ
            holidays.push(new Date(year, 9, 9));   // í•œê¸€ë‚ 
            holidays.push(new Date(year, 11, 25)); // í¬ë¦¬ìŠ¤ë§ˆìŠ¤
            
            // 2025ë…„ ìŒë ¥ ê³µíœ´ì¼
            if (year === 2025) {
                holidays.push(new Date(2025, 0, 28)); // ì„¤ë‚  ì „ë‚ 
                holidays.push(new Date(2025, 0, 29)); // ì„¤ë‚ 
                holidays.push(new Date(2025, 0, 30)); // ì„¤ë‚  ë‹¤ìŒë‚ 
                holidays.push(new Date(2025, 4, 5));  // ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ 
                holidays.push(new Date(2025, 9, 5));  // ì¶”ì„ ì „ë‚ 
                holidays.push(new Date(2025, 9, 6));  // ì¶”ì„
                holidays.push(new Date(2025, 9, 7));  // ì¶”ì„ ë‹¤ìŒë‚ 
            }
            
            // 2026ë…„ ìŒë ¥ ê³µíœ´ì¼
            if (year === 2026) {
                holidays.push(new Date(2026, 1, 16)); // ì„¤ë‚  ì „ë‚ 
                holidays.push(new Date(2026, 1, 17)); // ì„¤ë‚ 
                holidays.push(new Date(2026, 1, 18)); // ì„¤ë‚  ë‹¤ìŒë‚ 
                holidays.push(new Date(2026, 4, 24)); // ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ 
                holidays.push(new Date(2026, 8, 24)); // ì¶”ì„ ì „ë‚ 
                holidays.push(new Date(2026, 8, 25)); // ì¶”ì„
                holidays.push(new Date(2026, 8, 26)); // ì¶”ì„ ë‹¤ìŒë‚ 
            }
            
            return holidays;
        }

        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; // ì¼ìš”ì¼(0) ë˜ëŠ” í† ìš”ì¼(6)
        }

        function isHoliday(date, holidays) {
            return holidays.some(holiday => 
                holiday.getFullYear() === date.getFullYear() &&
                holiday.getMonth() === date.getMonth() &&
                holiday.getDate() === date.getDate()
            );
        }

        function isBusinessDay(date, holidays) {
            return !isWeekend(date) && !isHoliday(date, holidays);
        }

        function calculateDDay(dateStr) {
            if (!dateStr || dateStr.length !== 6) return { text: '', days: 0 };
            
            try {
                const year = 2000 + parseInt(dateStr.substring(0, 2));
                const month = parseInt(dateStr.substring(2, 4)) - 1;
                const day = parseInt(dateStr.substring(4, 6));
                
                const targetDate = new Date(year, month, day);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                targetDate.setHours(0, 0, 0, 0);
                
                // ì˜ì—…ì¼ ê³„ì‚°
                let businessDays = 0;
                
                if (today > targetDate) {
                    // D+ ê³„ì‚° (ê³¼ê±° ë‚ ì§œ)
                    let current = new Date(targetDate);
                    current.setDate(current.getDate() + 1);
                    
                    while (current <= today) {
                        const currentYear = current.getFullYear();
                        const holidays = getKoreanHolidays(currentYear);
                        
                        if (isBusinessDay(current, holidays)) {
                            businessDays++;
                        }
                        current.setDate(current.getDate() + 1);
                    }
                } else if (today < targetDate) {
                    // D- ê³„ì‚° (ë¯¸ë˜ ë‚ ì§œ)
                    let current = new Date(today);
                    current.setDate(current.getDate() + 1);
                    
                    while (current <= targetDate) {
                        const currentYear = current.getFullYear();
                        const holidays = getKoreanHolidays(currentYear);
                        
                        if (isBusinessDay(current, holidays)) {
                            businessDays++;
                        }
                        current.setDate(current.getDate() + 1);
                    }
                    businessDays = -businessDays;
                }
                
                let text = '';
                if (businessDays === 0) text = 'D-Day';
                else if (businessDays > 0) text = `D+${businessDays}`;
                else text = `D${businessDays}`;
                
                return { text: text, days: businessDays };
            } catch (e) {
                return { text: '', days: 0 };
            }
        }

        // ========== ì´ˆê¸°í™” ==========
        function resetInputs() {
            document.getElementById('chartType').value = 'minute';
            document.getElementById('stockName').value = '';
            document.getElementById('stockCode').value = '';  // ì¢…ëª©ì½”ë“œ ì´ˆê¸°í™” ì¶”ê°€
            document.getElementById('highDate').value = '';
            document.getElementById('highPrice').value = '';
            document.getElementById('lowPrice').value = '';
            document.getElementById('bouncePrice').value = '';
            document.getElementById('buyPoints').innerHTML = '';
            document.getElementById('sellTitle').textContent = 'ğŸ’° ë§¤ë„ íƒ€ì ';
            document.getElementById('sellPoints').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    ë°˜ë“±ì €ì ì„ ì…ë ¥í•˜ë©´<br>ë§¤ë„ íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤
                </div>
            `;
            currentSelectedIndex = -1;
            renderStockList();
        }

        // ========== ê³„ì‚° ==========
        function calculate() {
            const high = getNumericValue('highPrice');
            const low = getNumericValue('lowPrice');
            const bounce = getNumericValue('bouncePrice');

            if (high === null || low === null) {
                alert('ê³ ì ê³¼ ì €ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (high <= low) {
                alert('ê³ ì ì´ ì €ì ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }

            const diff = high - low;

            const buy40 = adjustBuyPrice(high - (diff * 0.382));
            const buy50 = adjustBuyPrice(high - (diff * 0.5));
            const buy60 = adjustBuyPrice(high - (diff * 0.6));
            const buy70 = adjustBuyPrice(high - (diff * 0.7));

            document.getElementById('buyPoints').innerHTML = `
                <div class="buy-box buy-40">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">40% ë§¤ìˆ˜ <span class="text-sm text-gray-600">38.2%</span></div>
                            <div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div>
                        </div>
                        <div class="text-2xl font-bold text-pink-600">${formatPriceWithOriginal(buy40.adjusted, buy40.original)}</div>
                    </div>
                </div>
                
                <div class="buy-box buy-50">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">50% ë§¤ìˆ˜</div>
                            <div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div>
                        </div>
                        <div class="text-2xl font-bold text-blue-600">${formatPriceWithOriginal(buy50.adjusted, buy50.original)}</div>
                    </div>
                </div>
                
                <div class="buy-box buy-60">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">60% ë§¤ìˆ˜</div>
                            <div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div>
                        </div>
                        <div class="text-2xl font-bold text-yellow-600">${formatPriceWithOriginal(buy60.adjusted, buy60.original)}</div>
                    </div>
                </div>
                
                <div class="buy-box buy-70">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">70% ë§¤ìˆ˜</div>
                            <div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div>
                        </div>
                        <div class="text-2xl font-bold text-red-600">${formatPriceWithOriginal(buy70.adjusted, buy70.original)}</div>
                    </div>
                </div>
            `;

            if (bounce !== null && bounce < high) {
                const bounceRange = high - bounce;
                
                const sell25 = adjustSellPrice(bounce + (bounceRange * 0.25));
                const sell33 = adjustSellPrice(bounce + (bounceRange * 0.33));
                const sell50 = adjustSellPrice(bounce + (bounceRange * 0.50));
                const sell66 = adjustSellPrice(bounce + (bounceRange * 0.66));
                const sell75 = adjustSellPrice(bounce + (bounceRange * 0.75));

                const riseRate4050 = (((buy40.adjusted - buy50.adjusted) / buy50.adjusted) * 100).toFixed(2);
                
                document.getElementById('sellTitle').innerHTML = `ğŸ’° ë§¤ë„ íƒ€ì  <span class="text-base font-normal text-gray-600">(40-50 ìƒìŠ¹ë¥ : ${riseRate4050}%)</span>`;

                document.getElementById('sellPoints').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <div class="font-bold">25% ë°˜ë“±</div>
                                <div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell25.adjusted, sell25.original)}</div>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <div class="font-bold">33% ë°˜ë“±</div>
                                <div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell33.adjusted, sell33.original)}</div>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <div class="font-bold">50% ë°˜ë“±</div>
                                <div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell50.adjusted, sell50.original)}</div>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <div class="font-bold">66% ë°˜ë“±</div>
                                <div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell66.adjusted, sell66.original)}</div>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <div class="font-bold">75% ë°˜ë“±</div>
                                <div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell75.adjusted, sell75.original)}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('sellTitle').textContent = 'ğŸ’° ë§¤ë„ íƒ€ì ';
                document.getElementById('sellPoints').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        ë°˜ë“±ì €ì ì„ ì…ë ¥í•˜ë©´<br>ë§¤ë„ íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤
                    </div>
                `;
            }
        }

        // ========== ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ ==========
        function addToList() {
            const chartType = document.getElementById('chartType').value;
            const stockName = document.getElementById('stockName').value;
            const stockCode = document.getElementById('stockCode').value;
            const highDate = document.getElementById('highDate').value;
            const high = getNumericValue('highPrice');
            const low = getNumericValue('lowPrice');
            const bounce = getNumericValue('bouncePrice');

            if (!stockName || high === null || low === null) {
                alert('ì¢…ëª©ëª…, ê³ ì , ì €ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const stockData = {
                chartType: chartType,
                name: stockName,
                code: stockCode || '',
                highDate: highDate || '',
                high: high,
                low: low,
                bounce: bounce,
                timestamp: new Date().toISOString(),
                currentPrice: null,
                changeRate: null,
                // ë§¤ìˆ˜íƒ€ì  ë„ë‹¬ ì´ë ¥ (í•œë²ˆ í„°ì¹˜í•˜ë©´ ì˜êµ¬ ì €ì¥)
                reachedHistory: {
                    reached40: false,
                    reached45: false,
                    reached50: false,
                    reached55: false,
                    reached60: false,
                    reached65: false,
                    reached70: false,
                    // ë§¤ë„íƒ€ì  ë„ë‹¬ ì´ë ¥
                    reachedSell25: false,
                    reachedSell33: false,
                    reachedSell50: false,
                    reachedSell75: false
                }
            };

            const existingIndex = stockDatabase.findIndex(stock => 
                stock.name === stockName && stock.chartType === chartType
            );
            
            if (existingIndex !== -1) {
                stockDatabase[existingIndex] = stockData;
                const chartTypeText = chartType === 'minute' ? 'ë¶„ë´‰' : 'ì¼ë´‰';
                alert(`"${stockName}" (${chartTypeText}) ì¢…ëª© ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } else {
                stockDatabase.unshift(stockData);
                const chartTypeText = chartType === 'minute' ? 'ë¶„ë´‰' : 'ì¼ë´‰';
                alert(`"${stockName}" (${chartTypeText}) ì¢…ëª©ì´ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            }
            
            localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
            renderStockList();
            
            // ì‹¤ì‹œê°„ ì‹œì„¸ ì¬ë“±ë¡
            registerAllStocks();
        }

        function renderStockList() {
            const minuteStocks = stockDatabase.filter(stock => stock.chartType === 'minute');
            const dailyStocks = stockDatabase.filter(stock => stock.chartType === 'daily');
            
            renderStockTable('minuteStockList', minuteStocks, 'minute');
            renderStockTable('dailyStockList', dailyStocks, 'daily');
        }

        function renderStockTable(elementId, stocks, chartType) {
            const listElement = document.getElementById(elementId);
            
            if (stocks.length === 0) {
                listElement.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        ì•„ì§ ì €ì¥ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                        "${chartType === 'minute' ? 'ë¶„ë´‰' : 'ì¼ë´‰'}" ì°¨íŠ¸ë¥¼ ì„ íƒí•˜ê³  "ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¢…ëª©ì„ ì €ì¥í•˜ì„¸ìš”.
                    </div>
                `;
                return;
            }

            listElement.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-xs">
                        <thead>
                            <tr class="bg-gradient-to-r ${chartType === 'minute' ? 'from-amber-100 to-yellow-100 border-amber-300' : 'from-blue-100 to-cyan-100 border-blue-300'} border-b-2">
                                <th class="p-2 text-left font-bold whitespace-nowrap">â‹®</th>
                                <th class="p-2 text-left font-bold whitespace-nowrap">ì¢…ëª©ëª…</th>
                                <th class="p-2 text-center font-bold text-pink-600 whitespace-nowrap">40%</th>
                                ${chartType === 'daily' ? '<th class="p-2 text-center font-bold text-gray-900 whitespace-nowrap">45%</th>' : ''}
                                <th class="p-2 text-center font-bold text-blue-600 whitespace-nowrap">50%</th>
                                ${chartType === 'daily' ? '<th class="p-2 text-center font-bold text-gray-900 whitespace-nowrap">55%</th>' : ''}
                                <th class="p-2 text-center font-bold text-yellow-600 whitespace-nowrap">60%</th>
                                ${chartType === 'daily' ? '<th class="p-2 text-center font-bold text-gray-900 whitespace-nowrap">65%</th>' : ''}
                                <th class="p-2 text-center font-bold text-red-600 whitespace-nowrap">70%</th>
                                <th class="p-2 text-center font-bold text-blue-500 whitespace-nowrap">25%â†‘</th>
                                <th class="p-2 text-center font-bold text-blue-500 whitespace-nowrap">33%â†‘</th>
                                <th class="p-2 text-center font-bold text-blue-500 whitespace-nowrap">50%â†‘</th>
                                <th class="p-2 text-center font-bold text-blue-500 whitespace-nowrap">75%â†‘</th>
                                <th class="p-2 text-center whitespace-nowrap">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stocks.map((stock) => {
                                const globalIndex = stockDatabase.findIndex(s => s.name === stock.name && s.timestamp === stock.timestamp);
                                const selected = globalIndex === currentSelectedIndex ? 'bg-purple-100' : '';
                                
                                const diff = stock.high - stock.low;
                                const buy40 = adjustBuyPrice(stock.high - (diff * 0.382));
                                const buy45 = adjustBuyPrice(stock.high - (diff * 0.45));
                                const buy50 = adjustBuyPrice(stock.high - (diff * 0.5));
                                const buy55 = adjustBuyPrice(stock.high - (diff * 0.55));
                                const buy60 = adjustBuyPrice(stock.high - (diff * 0.6));
                                const buy65 = adjustBuyPrice(stock.high - (diff * 0.65));
                                const buy70 = adjustBuyPrice(stock.high - (diff * 0.7));
                                
                                let sell25 = '-', sell33 = '-', sell50 = '-', sell75 = '-';
                                let sell25Price = null, sell33Price = null, sell50Price = null, sell75Price = null;
                                
                                if (stock.bounce !== null && stock.bounce !== undefined) {
                                    const bounceRange = stock.high - stock.bounce;
                                    sell25Price = adjustSellPrice(stock.bounce + (bounceRange * 0.25)).adjusted;
                                    sell33Price = adjustSellPrice(stock.bounce + (bounceRange * 0.33)).adjusted;
                                    sell50Price = adjustSellPrice(stock.bounce + (bounceRange * 0.50)).adjusted;
                                    sell75Price = adjustSellPrice(stock.bounce + (bounceRange * 0.75)).adjusted;
                                    
                                    // ë§¤ë„íƒ€ì  ê·¼ì ‘ë„ ì²´í¬
                                    const sellProximity25 = checkSellProximity(stock.currentPrice, sell25Price, chartType);
                                    const sellProximity33 = checkSellProximity(stock.currentPrice, sell33Price, chartType);
                                    const sellProximity50 = checkSellProximity(stock.currentPrice, sell50Price, chartType);
                                    const sellProximity75 = checkSellProximity(stock.currentPrice, sell75Price, chartType);
                                    
                                    // ë§¤ë„íƒ€ì  ë„ë‹¬ ì´ë ¥ ì²´í¬ ë° ì €ì¥
                                    if (!stock.reachedHistory) {
                                        stock.reachedHistory = {};
                                    }
                                    if (stock.currentPrice) {
                                        if (stock.currentPrice >= sell25Price && !stock.reachedHistory.reachedSell25) {
                                            stock.reachedHistory.reachedSell25 = true;
                                            localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                                        }
                                        if (stock.currentPrice >= sell33Price && !stock.reachedHistory.reachedSell33) {
                                            stock.reachedHistory.reachedSell33 = true;
                                            localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                                        }
                                        if (stock.currentPrice >= sell50Price && !stock.reachedHistory.reachedSell50) {
                                            stock.reachedHistory.reachedSell50 = true;
                                            localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                                        }
                                        if (stock.currentPrice >= sell75Price && !stock.reachedHistory.reachedSell75) {
                                            stock.reachedHistory.reachedSell75 = true;
                                            localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                                        }
                                    }
                                    
                                    const reachedSell25 = stock.reachedHistory?.reachedSell25 || false;
                                    const reachedSell33 = stock.reachedHistory?.reachedSell33 || false;
                                    const reachedSell50 = stock.reachedHistory?.reachedSell50 || false;
                                    const reachedSell75 = stock.reachedHistory?.reachedSell75 || false;
                                    
                                    // ë§¤ë„íƒ€ì  í‘œì‹œ (ë„ë‹¬: íŒŒë€ì‹¤ì„ , ê·¼ì ‘: íŒŒë€ë°•ìŠ¤)
                                    if (sellProximity25.isReached || reachedSell25) {
                                        sell25 = `<div class="sell-proximity-box-reached">${formatPrice(sell25Price)}</div>`;
                                    } else if (sellProximity25.isClose) {
                                        sell25 = `<div class="sell-proximity-box">${formatPrice(sell25Price)}</div>`;
                                    } else {
                                        sell25 = formatPrice(sell25Price);
                                    }
                                    
                                    if (sellProximity33.isReached || reachedSell33) {
                                        sell33 = `<div class="sell-proximity-box-reached">${formatPrice(sell33Price)}</div>`;
                                    } else if (sellProximity33.isClose) {
                                        sell33 = `<div class="sell-proximity-box">${formatPrice(sell33Price)}</div>`;
                                    } else {
                                        sell33 = formatPrice(sell33Price);
                                    }
                                    
                                    if (sellProximity50.isReached || reachedSell50) {
                                        sell50 = `<div class="sell-proximity-box-reached">${formatPrice(sell50Price)}</div>`;
                                    } else if (sellProximity50.isClose) {
                                        sell50 = `<div class="sell-proximity-box">${formatPrice(sell50Price)}</div>`;
                                    } else {
                                        sell50 = formatPrice(sell50Price);
                                    }
                                    
                                    if (sellProximity75.isReached || reachedSell75) {
                                        sell75 = `<div class="sell-proximity-box-reached">${formatPrice(sell75Price)}</div>`;
                                    } else if (sellProximity75.isClose) {
                                        sell75 = `<div class="sell-proximity-box">${formatPrice(sell75Price)}</div>`;
                                    } else {
                                        sell75 = formatPrice(sell75Price);
                                    }
                                }
                                
                                const dday = calculateDDay(stock.highDate);
                                let ddayBadge = '';
                                let is40Disabled = false; // 40% íƒ€ì  ê¸ˆì§€ ì—¬ë¶€
                                
                                if (dday.text) {
                                    let badgeClass = 'd-day-badge';
                                    if (chartType === 'minute' && dday.days > 0) {
                                        if (dday.days >= 30) {
                                            badgeClass += ' danger'; // D+30 ì´ìƒ: ë¹¨ê°„ìƒ‰
                                        } else if (dday.days >= 14) {
                                            badgeClass += ' warning'; // D+14~29: ë…¸ë€ìƒ‰
                                        } else if (dday.days >= 2) {
                                            // D+2~13: ë³´ë¼ìƒ‰ (ê¸°ë³¸)
                                            is40Disabled = true; // D+2ë¶€í„° 40% ê¸ˆì§€
                                        } else if (dday.days >= 0) {
                                            badgeClass += ' orange'; // D+0~1: ì£¼í™©ìƒ‰
                                        }
                                    } else if (chartType === 'daily' && dday.days > 0) {
                                        if (dday.days >= 80) {
                                            badgeClass += ' danger'; // D+80 ì´ìƒ: ë¹¨ê°„ìƒ‰
                                        } else if (dday.days >= 60) {
                                            badgeClass += ' warning'; // D+60~79: ë…¸ë€ìƒ‰
                                        }
                                    }
                                    ddayBadge = `<span class="${badgeClass}">${dday.text}</span>`;
                                }
                                
                                const riseRate = (((buy40.adjusted - buy50.adjusted) / buy50.adjusted) * 100).toFixed(2);
                                const riseRateBadge = `<span class="rise-rate-badge">${riseRate}%</span>`;
                                
                                // í˜„ì¬ê°€/ë“±ë½ë¥  í‘œì‹œ
                                let priceInfo = '';
                                if (stock.currentPrice && stock.changeRate !== null) {
                                    const priceClass = stock.changeRate > 0 ? 'price-up' : stock.changeRate < 0 ? 'price-down' : 'price-flat';
                                    const arrow = stock.changeRate > 0 ? 'â–²' : stock.changeRate < 0 ? 'â–¼' : '';
                                    priceInfo = `<span class="realtime-price">
                                        <span class="realtime-price-value ${priceClass}">${stock.currentPrice.toLocaleString()}ì›</span>
                                        <span class="realtime-price-change ${priceClass}">${arrow} ${stock.changeRate.toFixed(2)}%</span>
                                    </span>`;
                                }
                                
                                // ë§¤ìˆ˜íƒ€ì  ê·¼ì ‘ë„ ì²´í¬ (chartType ì „ë‹¬)
                                const proximity40 = checkProximity(stock.currentPrice, buy40.adjusted, chartType);
                                const proximity50 = checkProximity(stock.currentPrice, buy50.adjusted, chartType);
                                const proximity60 = checkProximity(stock.currentPrice, buy60.adjusted, chartType);
                                const proximity70 = checkProximity(stock.currentPrice, buy70.adjusted, chartType);
                                
                                // ë„ë‹¬ ì´ë ¥ ì´ˆê¸°í™” (ì—†ìœ¼ë©´ ìƒì„±)
                                if (!stock.reachedHistory) {
                                    stock.reachedHistory = {
                                        reached40: false,
                                        reached45: false,
                                        reached50: false,
                                        reached55: false,
                                        reached60: false,
                                        reached65: false,
                                        reached70: false,
                                        reachedSell25: false,
                                        reachedSell33: false,
                                        reachedSell50: false,
                                        reachedSell75: false
                                    };
                                }
                                
                                // í˜„ì¬ ê°€ê²©ì´ ê° íƒ€ì ì— ë„ë‹¬í–ˆëŠ”ì§€ ì²´í¬í•˜ê³  ì´ë ¥ì— ì €ì¥
                                if (stock.currentPrice) {
                                    if (stock.currentPrice <= buy40.adjusted && !stock.reachedHistory.reached40) {
                                        stock.reachedHistory.reached40 = true;
                                        localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                                    }
                                    if (stock.currentPrice <= buy45.adjusted && !stock.reachedHistory.reached45) {
                                        stock.reachedHistory.reached45 = true;
                                        localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                                    }
                                    if (stock.currentPrice <= buy50.adjusted && !stock.reachedHistory.reached50) {
                                        stock.reachedHistory.reached50 = true;
                                        localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                                    }
                                    if (stock.currentPrice <= buy55.adjusted && !stock.reachedHistory.reached55) {
                                        stock.reachedHistory.reached55 = true;
                                        localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                                    }
                                    if (stock.currentPrice <= buy60.adjusted && !stock.reachedHistory.reached60) {
                                        stock.reachedHistory.reached60 = true;
                                        localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                                    }
                                    if (stock.currentPrice <= buy65.adjusted && !stock.reachedHistory.reached65) {
                                        stock.reachedHistory.reached65 = true;
                                        localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                                    }
                                    if (stock.currentPrice <= buy70.adjusted && !stock.reachedHistory.reached70) {
                                        stock.reachedHistory.reached70 = true;
                                        localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                                    }
                                }
                                
                                // ì´ë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ ë„ë‹¬ ì—¬ë¶€ ê²°ì • (í•œë²ˆ í„°ì¹˜í•˜ë©´ ì˜êµ¬ ìœ ì§€)
                                const reached40 = stock.reachedHistory.reached40;
                                const reached45 = stock.reachedHistory.reached45;
                                const reached50 = stock.reachedHistory.reached50;
                                const reached55 = stock.reachedHistory.reached55;
                                const reached60 = stock.reachedHistory.reached60;
                                const reached65 = stock.reachedHistory.reached65;
                                const reached70 = stock.reachedHistory.reached70;
                                
                                // 40% íƒ€ì  í‘œì‹œ (ê¸ˆì§€ ì—¬ë¶€ ë° ë„ë‹¬ ì—¬ë¶€ì— ë”°ë¼)
                                let buy40Display;
                                if (is40Disabled) {
                                    buy40Display = '<span style="text-decoration: line-through; opacity: 0.4;">' + formatPrice(buy40.adjusted) + '</span> <span style="color: #ef4444;">ğŸš«</span>';
                                } else {
                                    // 3ë‹¨ê³„ í‘œì‹œ: ë…¹ìƒ‰(ê·¼ì ‘), ì£¼í™©(ë„ë‹¬), ì£¼í™©ì‹¤ì„ (ë„ë‹¬ì´í•˜/ê³¼ê±°ë„ë‹¬)
                                    if (proximity40.isBelow || reached40) {
                                        buy40Display = `<div class="proximity-box-below">${formatPrice(buy40.adjusted)}</div>`;
                                    } else if (proximity40.isEqual) {
                                        buy40Display = `<div class="proximity-box-equal">${formatPrice(buy40.adjusted)}</div>`;
                                    } else if (proximity40.isClose) {
                                        buy40Display = `<div class="proximity-box">${formatPrice(buy40.adjusted)}</div>`;
                                    } else {
                                        buy40Display = formatPrice(buy40.adjusted);
                                    }
                                }
                                
                                // 45% íƒ€ì  (ì¼ë´‰ ì „ìš©)
                                const buy45Display = reached45 
                                    ? `<div class="proximity-box-below">${formatPrice(buy45.adjusted)}</div>`
                                    : formatPrice(buy45.adjusted);
                                
                                // 50% íƒ€ì  (3ë‹¨ê³„)
                                let buy50Display;
                                if (proximity50.isBelow || reached50) {
                                    buy50Display = `<div class="proximity-box-below">${formatPrice(buy50.adjusted)}</div>`;
                                } else if (proximity50.isEqual) {
                                    buy50Display = `<div class="proximity-box-equal">${formatPrice(buy50.adjusted)}</div>`;
                                } else if (proximity50.isClose) {
                                    buy50Display = `<div class="proximity-box">${formatPrice(buy50.adjusted)}</div>`;
                                } else {
                                    buy50Display = formatPrice(buy50.adjusted);
                                }
                                
                                // 55% íƒ€ì  (ì¼ë´‰ ì „ìš©)
                                const buy55Display = reached55
                                    ? `<div class="proximity-box-below">${formatPrice(buy55.adjusted)}</div>`
                                    : formatPrice(buy55.adjusted);
                                
                                // 60% íƒ€ì  (3ë‹¨ê³„)
                                let buy60Display;
                                if (proximity60.isBelow || reached60) {
                                    buy60Display = `<div class="proximity-box-below">${formatPrice(buy60.adjusted)}</div>`;
                                } else if (proximity60.isEqual) {
                                    buy60Display = `<div class="proximity-box-equal">${formatPrice(buy60.adjusted)}</div>`;
                                } else if (proximity60.isClose) {
                                    buy60Display = `<div class="proximity-box">${formatPrice(buy60.adjusted)}</div>`;
                                } else {
                                    buy60Display = formatPrice(buy60.adjusted);
                                }
                                
                                // 65% íƒ€ì  (ì¼ë´‰ ì „ìš©)
                                const buy65Display = reached65
                                    ? `<div class="proximity-box-below">${formatPrice(buy65.adjusted)}</div>`
                                    : formatPrice(buy65.adjusted);
                                
                                // 70% íƒ€ì  (3ë‹¨ê³„)
                                let buy70Display;
                                if (proximity70.isBelow || reached70) {
                                    buy70Display = `<div class="proximity-box-below">${formatPrice(buy70.adjusted)}</div>`;
                                } else if (proximity70.isEqual) {
                                    buy70Display = `<div class="proximity-box-equal">${formatPrice(buy70.adjusted)}</div>`;
                                } else if (proximity70.isClose) {
                                    buy70Display = `<div class="proximity-box">${formatPrice(buy70.adjusted)}</div>`;
                                } else {
                                    buy70Display = formatPrice(buy70.adjusted);
                                }
                                
                                return `
                                    <tr class="${selected} ${chartType === 'minute' ? 'hover:bg-amber-50' : 'hover:bg-blue-50'} cursor-pointer border-b transition-colors whitespace-nowrap" 
                                        draggable="true"
                                        ondragstart="handleDragStart(event, ${globalIndex})"
                                        ondragover="handleDragOver(event)"
                                        ondrop="handleDrop(event, ${globalIndex})"
                                        ondragend="handleDragEnd(event)"
                                        onclick="loadStock(${globalIndex})">
                                        <td class="drag-handle" onclick="event.stopPropagation()">â‹®â‹®</td>
                                        <td class="p-2 font-bold">${stock.name}${ddayBadge}${riseRateBadge}${priceInfo}</td>
                                        <td class="p-2 text-center text-pink-600 font-semibold">${buy40Display}</td>
                                        ${chartType === 'daily' ? `<td class="p-2 text-center text-gray-900 font-semibold">${buy45Display}</td>` : ''}
                                        <td class="p-2 text-center text-blue-600 font-semibold">${buy50Display}</td>
                                        ${chartType === 'daily' ? `<td class="p-2 text-center text-gray-900 font-semibold">${buy55Display}</td>` : ''}
                                        <td class="p-2 text-center text-yellow-600 font-semibold">${buy60Display}</td>
                                        ${chartType === 'daily' ? `<td class="p-2 text-center text-gray-900 font-semibold">${buy65Display}</td>` : ''}
                                        <td class="p-2 text-center text-red-600 font-semibold">${buy70Display}</td>
                                        <td class="p-2 text-center text-blue-500 font-semibold">${sell25}</td>
                                        <td class="p-2 text-center text-blue-500 font-semibold">${sell33}</td>
                                        <td class="p-2 text-center text-blue-500 font-semibold">${sell50}</td>
                                        <td class="p-2 text-center text-blue-500 font-semibold">${sell75}</td>
                                        <td class="p-2 text-center">
                                            <button class="delete-btn" onclick="deleteStock(${globalIndex}, event)">ì‚­ì œ</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function handleDragStart(e, index) {
            draggedIndex = index;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e, targetIndex) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedIndex === null || draggedIndex === targetIndex) {
                return false;
            }

            const draggedItem = stockDatabase[draggedIndex];
            stockDatabase.splice(draggedIndex, 1);
            stockDatabase.splice(targetIndex, 0, draggedItem);

            if (currentSelectedIndex === draggedIndex) {
                currentSelectedIndex = targetIndex;
            } else if (draggedIndex < currentSelectedIndex && targetIndex >= currentSelectedIndex) {
                currentSelectedIndex--;
            } else if (draggedIndex > currentSelectedIndex && targetIndex <= currentSelectedIndex) {
                currentSelectedIndex++;
            }

            localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
            renderStockList();
            
            return false;
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedIndex = null;
        }

        function loadStock(index) {
            currentSelectedIndex = index;
            const stock = stockDatabase[index];
            
            document.getElementById('chartType').value = stock.chartType || 'minute';
            document.getElementById('stockName').value = stock.name;
            document.getElementById('stockCode').value = stock.code || '';
            document.getElementById('highDate').value = stock.highDate || '';
            document.getElementById('highPrice').value = stock.high.toLocaleString('ko-KR');
            document.getElementById('lowPrice').value = stock.low.toLocaleString('ko-KR');
            document.getElementById('bouncePrice').value = stock.bounce !== null ? stock.bounce.toLocaleString('ko-KR') : '';
            
            calculate();
            renderStockList();
        }

        function deleteStock(index, event) {
            event.stopPropagation();
            
            const stock = stockDatabase[index];
            if (confirm(`"${stock.name}" ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                stockDatabase.splice(index, 1);
                localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                
                if (currentSelectedIndex === index) {
                    currentSelectedIndex = -1;
                } else if (currentSelectedIndex > index) {
                    currentSelectedIndex--;
                }
                
                renderStockList();
                
                // ì‹¤ì‹œê°„ ì‹œì„¸ ì¬ë“±ë¡
                registerAllStocks();
            }
        }

        // ========== í˜ì´ì§€ ë¡œë“œ ==========
        window.onload = function() {
            renderStockList();
            gapiLoaded();
            gisLoaded();
            
            // í‚¤ì›€ API ìë™ ì—°ê²° ì‹œë„
            connectKiwoomAPI();
            
            const waitForInit = setInterval(async () => {
                if (gapiInited && gisInited) {
                    clearInterval(waitForInit);
                    await restoreLoginState();
                }
            }, 100);
        };
    </script>
    
    <!-- ì•Œë¦¼ ì„¤ì • ëª¨ë‹¬ -->
    <div id="alertModal" class="alert-modal">
        <div class="alert-modal-content">
            <h2 class="text-2xl font-bold mb-6">ğŸ”” ì•Œë¦¼ ì„¤ì •</h2>
            
            <div class="space-y-4">
                <!-- ì•Œë¦¼ìŒ ì„¤ì • -->
                <div class="flex items-center justify-between">
                    <label class="font-semibold">ì•Œë¦¼ìŒ í™œì„±í™”</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundAlertToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <!-- ì•Œë¦¼ ë¯¼ê°ë„ -->
                <div>
                    <label class="font-semibold block mb-2">ì•Œë¦¼ ë¯¼ê°ë„ (ë§¤ìˆ˜íƒ€ì  ê·¼ì ‘ %)</label>
                    <input type="number" id="alertThreshold" value="2" min="0.5" max="10" step="0.5" 
                           class="border-2 border-gray-300 rounded-lg px-4 py-2 w-full">
                    <p class="text-sm text-gray-600 mt-1">ë§¤ìˆ˜íƒ€ì ì—ì„œ Â±ì´ ë²”ìœ„ ë‚´ì— ì˜¤ë©´ ì•Œë¦¼</p>
                </div>
                
                <!-- í…”ë ˆê·¸ë¨ ì„¤ì • ì•ˆë‚´ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-900 mb-2">ğŸ“± í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì„¤ì •</h3>
                    <p class="text-sm text-blue-800 mb-2">
                        í…”ë ˆê·¸ë¨ ì•Œë¦¼ì€ ì„œë²„(app.py) íŒŒì¼ì—ì„œ ì„¤ì •í•©ë‹ˆë‹¤:
                    </p>
                    <ol class="text-sm text-blue-700 list-decimal ml-5 space-y-1">
                        <li>BotFatherì—ì„œ ë´‡ ìƒì„± í›„ í† í° ë°›ê¸°</li>
                        <li>app.pyì—ì„œ TELEGRAM_BOT_TOKEN ì„¤ì •</li>
                        <li>ë´‡ê³¼ ëŒ€í™” í›„ TELEGRAM_CHAT_ID ì„¤ì •</li>
                        <li>TELEGRAM_ENABLED = Trueë¡œ ë³€ê²½</li>
                    </ol>
                </div>
                
                <!-- í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
                <div class="flex gap-3">
                    <button onclick="testAlertSound()" 
                            class="flex-1 bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition">
                        ğŸ”Š ë§¤ìˆ˜ ì•Œë¦¼ìŒ
                    </button>
                    <button onclick="testSellAlertSound()" 
                            class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">
                        ğŸ”Š ë§¤ë„ ì•Œë¦¼ìŒ
                    </button>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="saveAlertSettings()" 
                        class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                    ì €ì¥
                </button>
                <button onclick="closeAlertSettings()" 
                        class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-semibold hover:bg-gray-500 transition">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ì•Œë¦¼ ì„¤ì • ë³€ìˆ˜
        let soundAlertEnabled = true;
        let alertThreshold = 2.0;
        
        // Web Audio APIë¡œ ì•Œë¦¼ìŒ ìƒì„±
        let audioContext;
        let alertSound;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        function playAlertSound() {
            if (!soundAlertEnabled) return;
            
            try {
                initAudio();
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // ì²« ë²ˆì§¸ ë¹„í”„ìŒ
                oscillator.frequency.value = 800;
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                
                // ë‘ ë²ˆì§¸ ë¹„í”„ìŒ
                setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    
                    osc2.frequency.value = 1000;
                    gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    osc2.start(audioContext.currentTime);
                    osc2.stop(audioContext.currentTime + 0.2);
                }, 150);
                
            } catch (e) {
                console.error('ì•Œë¦¼ìŒ ì¬ìƒ ì˜¤ë¥˜:', e);
            }
        }
        
        // ë§¤ë„ ì•Œë¦¼ìŒ (MP3 íŒŒì¼ ì¬ìƒ)
        let sellAlertAudio = null;
        
        function initSellAlertSound() {
            if (!sellAlertAudio) {
                sellAlertAudio = new Audio('sell_alert.mp3');
                sellAlertAudio.volume = 0.7;
            }
        }
        
        function playSellAlertSound() {
            if (!soundAlertEnabled) return;
            
            try {
                initSellAlertSound();
                sellAlertAudio.currentTime = 0;
                sellAlertAudio.play().catch(e => {
                    console.error('ë§¤ë„ ì•Œë¦¼ìŒ ì¬ìƒ ì˜¤ë¥˜:', e);
                    // MP3 ì¬ìƒ ì‹¤íŒ¨ì‹œ ëŒ€ì²´ ë¹„í”„ìŒ
                    playFallbackSellSound();
                });
            } catch (e) {
                console.error('ë§¤ë„ ì•Œë¦¼ìŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
                playFallbackSellSound();
            }
        }
        
        // MP3 ì¬ìƒ ì‹¤íŒ¨ì‹œ ëŒ€ì²´ ë¹„í”„ìŒ (ë†’ì€ ìŒìƒ‰ 3ì—°ì†)
        function playFallbackSellSound() {
            try {
                initAudio();
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1200;
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
                
                setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    
                    osc2.frequency.value = 1500;
                    gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                    
                    osc2.start(audioContext.currentTime);
                    osc2.stop(audioContext.currentTime + 0.15);
                }, 100);
                
                setTimeout(() => {
                    const osc3 = audioContext.createOscillator();
                    const gain3 = audioContext.createGain();
                    
                    osc3.connect(gain3);
                    gain3.connect(audioContext.destination);
                    
                    osc3.frequency.value = 1800;
                    gain3.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gain3.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    osc3.start(audioContext.currentTime);
                    osc3.stop(audioContext.currentTime + 0.2);
                }, 200);
                
            } catch (e) {
                console.error('ëŒ€ì²´ ì•Œë¦¼ìŒ ì¬ìƒ ì˜¤ë¥˜:', e);
            }
        }
        
        function testAlertSound() {
            playAlertSound();
        }
        
        function testSellAlertSound() {
            playSellAlertSound();
        }
        
        function showAlertToast(message, type = 'near', watchMode = 'buy') {
            // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
            const existingToast = document.querySelector('.alert-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'alert-toast';
            
            // ë§¤ìˆ˜/ë§¤ë„ì— ë”°ë¼ ë‹¤ë¥¸ ë©”ì‹œì§€ì™€ ìŠ¤íƒ€ì¼
            let title, bgColor;
            if (watchMode === 'sell') {
                title = type === 'reached' ? 'ğŸ’° ë§¤ë„íƒ€ì  ë„ë‹¬!' : 'ğŸ“ˆ ë§¤ë„íƒ€ì  ê·¼ì ‘!';
                bgColor = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)'; // íŒŒë€ìƒ‰ ê³„ì—´
            } else {
                title = type === 'reached' ? 'ğŸ¯ ë§¤ìˆ˜íƒ€ì  ë„ë‹¬!' : 'âš ï¸ ë§¤ìˆ˜íƒ€ì  ê·¼ì ‘!';
                bgColor = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'; // ì£¼í™©ìƒ‰ ê³„ì—´
            }
            
            toast.style.background = bgColor;
            toast.innerHTML = `
                <div class="font-bold mb-1">${title}</div>
                <div class="text-sm">${message}</div>
            `;
            document.body.appendChild(toast);
            
            // ë§¤ìˆ˜/ë§¤ë„ì— ë”°ë¼ ë‹¤ë¥¸ ì•Œë¦¼ìŒ
            if (watchMode === 'sell') {
                playSellAlertSound();
            } else {
                playAlertSound();
            }
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        
        function openAlertSettings() {
            document.getElementById('alertModal').classList.add('active');
            
            // í˜„ì¬ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            soundAlertEnabled = localStorage.getItem('soundAlertEnabled') !== 'false';
            alertThreshold = parseFloat(localStorage.getItem('alertThreshold') || '2.0');
            
            document.getElementById('soundAlertToggle').checked = soundAlertEnabled;
            document.getElementById('alertThreshold').value = alertThreshold;
        }
        
        function closeAlertSettings() {
            document.getElementById('alertModal').classList.remove('active');
        }
        
        function saveAlertSettings() {
            soundAlertEnabled = document.getElementById('soundAlertToggle').checked;
            alertThreshold = parseFloat(document.getElementById('alertThreshold').value);
            
            localStorage.setItem('soundAlertEnabled', soundAlertEnabled);
            localStorage.setItem('alertThreshold', alertThreshold);
            
            // ì„œë²„ì— ì•Œë¦¼ ì„¤ì • ì „ì†¡
            if (socket && socket.connected) {
                socket.emit('update_alert_config', {
                    threshold: alertThreshold
                });
            }
            
            alert('ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeAlertSettings();
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
        soundAlertEnabled = localStorage.getItem('soundAlertEnabled') !== 'false';
        alertThreshold = parseFloat(localStorage.getItem('alertThreshold') || '2.0');
    </script>
</body>
</html>
